<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #000; color: white; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        .spotify-gradient { background: linear-gradient(to bottom, #222, #121212); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(20px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        .loading-alert {
            display: none;
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(29, 185, 84, 0.9);
            padding: 12px 24px;
            border-radius: 50px;
            z-index: 1000;
            animation: fadeInOut 2s ease-in-out forwards;
        }

        #music-player-ui {
            transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
            transform: translateY(100%);
        }
        #music-player-ui.active { transform: translateY(0); }

        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <div id="loadingAlert" class="loading-alert items-center gap-3 flex">
        <div class="loading-spinner"></div>
        <span id="alertText" class="font-bold">取得中...</span>
    </div>

    <main id="main-view" class="flex-1 overflow-y-auto spotify-gradient no-scrollbar pb-40">
        <header class="sticky top-0 z-30 bg-[#121212]/90 backdrop-blur-lg p-4">
            <div class="relative w-full">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="searchInput" placeholder="曲名、アーティスト名で検索" 
                       class="w-full bg-[#242424] rounded-full py-3 pl-12 pr-4 focus:outline-none text-base border-none">
            </div>
        </header>

        <section id="content-section" class="p-4">
            <h2 id="viewTitle" class="text-2xl font-bold mb-4">注目の楽曲</h2>
            <div id="resultsGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
        </section>
    </main>

    <footer id="player-bar" onclick="openFullPlayer()" class="fixed bottom-[64px] left-0 w-full bg-[#181818] border-t border-gray-800 p-2 flex items-center justify-between z-40 transition-transform translate-y-full">
        <div class="flex items-center gap-3 w-2/3">
            <img id="currentThumb" src="" class="w-12 h-12 rounded shadow-md object-cover">
            <div class="overflow-hidden text-left">
                <div id="currentTitle" class="text-sm font-bold truncate">曲名</div>
                <div id="currentArtist" class="text-xs text-gray-400 truncate">アーティスト</div>
            </div>
        </div>
        <div class="flex items-center gap-4 pr-2" onclick="event.stopPropagation()">
            <button id="favoriteBtn" class="text-xl text-gray-400"><i class="far fa-heart"></i></button>
            <button id="playBtn" class="text-3xl text-white"><i id="playIcon" class="fas fa-play-circle"></i></button>
        </div>
        <div class="absolute top-0 left-0 w-full h-[2px] bg-gray-700">
            <div id="progressLine" class="h-full bg-green-500 w-0"></div>
        </div>
    </footer>

    <div id="music-player-ui" class="fixed inset-0 bg-black z-[60] flex flex-col p-8">
        <button onclick="closeFullPlayer()" class="text-2xl mb-8 self-start"><i class="fas fa-chevron-down"></i></button>
        
        <div class="flex-1 flex flex-col items-center justify-center">
            <img id="fullThumb" src="" class="w-full aspect-square max-w-sm rounded-lg shadow-2xl mb-12 transition-transform duration-500 shadow-white/10">
            <div class="w-full text-left max-w-sm">
                <h1 id="fullTitle" class="text-2xl font-bold truncate">曲名</h1>
                <p id="fullArtist" class="text-lg text-gray-400 truncate">アーティスト</p>
            </div>
        </div>

        <div class="w-full max-w-sm mx-auto mb-12">
            <input type="range" id="fullSeekBar" value="0" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer accent-white">
            <div class="flex justify-between text-xs text-gray-400 mt-2">
                <span id="currentTime">0:00</span>
                <span id="totalTime">0:00</span>
            </div>
            <div class="flex justify-around items-center mt-8">
                <button class="text-2xl"><i class="fas fa-random text-gray-400"></i></button>
                <button class="text-3xl"><i class="fas fa-step-backward"></i></button>
                <button id="fullPlayBtn" class="bg-white text-black w-16 h-16 rounded-full flex items-center justify-center text-2xl">
                    <i id="fullPlayIcon" class="fas fa-play ml-1"></i>
                </button>
                <button class="text-3xl"><i class="fas fa-step-forward"></i></button>
                <button id="downloadBtn" class="text-2xl text-gray-400">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 w-full bg-black/95 border-t border-gray-900 flex justify-around items-center h-16 z-50">
        <button onclick="showHome()" class="flex flex-col items-center gap-1 text-gray-400 nav-item" id="nav-home">
            <i class="fas fa-home text-xl"></i><span class="text-[10px]">ホーム</span>
        </button>
        <button onclick="document.getElementById('searchInput').focus()" class="flex flex-col items-center gap-1 text-gray-400 nav-item">
            <i class="fas fa-search text-xl"></i><span class="text-[10px]">検索</span>
        </button>
        <button onclick="showLibrary()" class="flex flex-col items-center gap-1 text-gray-400 nav-item" id="nav-lib">
            <i class="fas fa-book text-xl"></i><span class="text-[10px]">ライブラリ</span>
        </button>
    </nav>

    <audio id="audioPlayer"></audio>

    <script>
        const audio = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const fullPlayBtn = document.getElementById('fullPlayBtn');
        const fullPlayIcon = document.getElementById('fullPlayIcon');
        const searchInput = document.getElementById('searchInput');
        const resultsGrid = document.getElementById('resultsGrid');
        const playerBar = document.getElementById('player-bar');
        const progressLine = document.getElementById('progressLine');
        const fullSeekBar = document.getElementById('fullSeekBar');
        const loadingAlert = document.getElementById('loadingAlert');
        const alertText = document.getElementById('alertText');
        const fullPlayer = document.getElementById('music-player-ui');
        const downloadBtn = document.getElementById('downloadBtn');

        let currentTrack = null;
        let isLoading = false;

        searchInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const query = searchInput.value;
                if (!query) return;
                document.getElementById('viewTitle').innerText = `「${query}」の検索結果`;
                resultsGrid.innerHTML = '<div class="col-span-2 text-center py-10"><i class="fas fa-spinner fa-spin text-3xl"></i></div>';
                try {
                    const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    renderResults(data.results);
                } catch (err) { console.error(err); }
            }
        });

        function renderResults(songs) {
            resultsGrid.innerHTML = '';
            songs.forEach(song => {
                const div = document.createElement('div');
                div.className = 'bg-[#181818] p-3 rounded-md active:scale-95 transition-transform cursor-pointer';
                div.innerHTML = `
                    <img src="https://img.youtube.com/vi/${song.videoId}/mqdefault.jpg" class="w-full aspect-square object-cover rounded mb-2">
                    <div class="text-sm font-bold truncate">${song.title}</div>
                    <div class="text-xs text-gray-400 truncate">${song.author}</div>
                `;
                div.onclick = () => playSong(song);
                resultsGrid.appendChild(div);
            });
        }

        async function playSong(song) {
            currentTrack = song;
            isLoading = true;
            alertText.innerText = "音声を取得中...";
            loadingAlert.style.display = 'flex';
            setTimeout(() => { loadingAlert.style.display = 'none'; }, 2000);

            playerBar.classList.remove('translate-y-full');
            document.getElementById('currentTitle').innerText = song.title;
            document.getElementById('currentArtist').innerText = song.author;
            document.getElementById('currentThumb').src = `https://img.youtube.com/vi/${song.videoId}/mqdefault.jpg`;
            document.getElementById('fullTitle').innerText = song.title;
            document.getElementById('fullArtist').innerText = song.author;
            document.getElementById('fullThumb').src = `https://img.youtube.com/vi/${song.videoId}/mqdefault.jpg`;

            audio.src = `/api/streamurl?video_id=${song.videoId}`;
            try {
                await audio.play();
                isLoading = false;
                updatePlayIcon(true);
            } catch (e) { console.log("Play failed"); }
        }

        function updatePlayIcon(isPlaying) {
            playIcon.className = isPlaying ? 'fas fa-pause-circle' : 'fas fa-play-circle';
            fullPlayIcon.className = isPlaying ? 'fas fa-pause' : 'fas fa-play ml-1';
        }

        function togglePlay() {
            if (audio.paused) { audio.play(); updatePlayIcon(true); }
            else { audio.pause(); updatePlayIcon(false); }
        }

        playBtn.onclick = (e) => { e.stopPropagation(); togglePlay(); };
        fullPlayBtn.onclick = togglePlay;

        audio.ontimeupdate = () => {
            if (!audio.duration) return;
            const pct = (audio.currentTime / audio.duration) * 100;
            progressLine.style.width = `${pct}%`;
            fullSeekBar.value = pct;
            document.getElementById('currentTime').innerText = formatTime(audio.currentTime);
            document.getElementById('totalTime').innerText = formatTime(audio.duration);
        };

        fullSeekBar.oninput = () => { audio.currentTime = (fullSeekBar.value / 100) * audio.duration; };

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        downloadBtn.onclick = () => {
            if (!currentTrack) return;
            alertText.innerText = "保存中...";
            loadingAlert.style.display = 'flex';
            
            const url = `/api/download?video_id=${currentTrack.videoId}&title=${encodeURIComponent(currentTrack.title)}`;
            const a = document.createElement('a');
            a.href = url;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            setTimeout(() => { loadingAlert.style.display = 'none'; }, 3000);
        };

        function openFullPlayer() { fullPlayer.classList.add('active'); }
        function closeFullPlayer() { fullPlayer.classList.remove('active'); }

        function showHome() { document.getElementById('viewTitle').innerText = "注目の楽曲"; }
        function showLibrary() {
            document.getElementById('viewTitle').innerText = "ライブラリ";
            let playlist = JSON.parse(localStorage.getItem('myPlaylist') || '[]');
            renderResults(playlist);
        }

        document.getElementById('favoriteBtn').onclick = (e) => {
            e.stopPropagation();
            if (!currentTrack) return;
            let playlist = JSON.parse(localStorage.getItem('myPlaylist') || '[]');
            const idx = playlist.findIndex(s => s.videoId === currentTrack.videoId);
            if (idx === -1) {
                playlist.push(currentTrack);
                document.getElementById('favoriteBtn').innerHTML = '<i class="fas fa-heart text-green-500"></i>';
            } else {
                playlist.splice(idx, 1);
                document.getElementById('favoriteBtn').innerHTML = '<i class="far fa-heart"></i>';
            }
            localStorage.setItem('myPlaylist', JSON.stringify(playlist));
        };
    </script>
</body>
</html>
