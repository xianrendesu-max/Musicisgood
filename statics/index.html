<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #000; color: white; -webkit-tap-highlight-color: transparent; font-family: sans-serif; }
        .spotify-gradient { background: linear-gradient(to bottom, #222, #121212); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes fadeIn {
            0% { opacity: 0; transform: translate(-50%, 20px); }
            100% { opacity: 1; transform: translate(-50%, 0); }
        }
        
        .loading-alert {
            display: none;
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(29, 185, 84, 0.95);
            padding: 12px 24px;
            border-radius: 50px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .loading-alert.active {
            display: flex;
            animation: fadeIn 0.3s ease-out forwards;
        }

        #music-player-ui {
            transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1);
            transform: translateY(100%);
        }
        #music-player-ui.active { transform: translateY(0); }

        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <div id="loadingAlert" class="loading-alert items-center gap-3">
        <div class="loading-spinner"></div>
        <span class="font-bold">音声を取得中...</span>
    </div>

    <main id="main-view" class="flex-1 overflow-y-auto spotify-gradient no-scrollbar pb-40">
        <header class="sticky top-0 z-30 bg-[#121212]/90 backdrop-blur-lg p-4">
            <div class="relative w-full">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="searchInput" placeholder="曲名、アーティスト名で検索" 
                       class="w-full bg-[#242424] rounded-full py-3 pl-12 pr-4 focus:outline-none text-base border-none">
            </div>
        </header>

        <section id="content-section" class="p-4">
            <h2 id="viewTitle" class="text-2xl font-bold mb-4">お気に入りの音楽</h2>
            <div id="resultsGrid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <div class="col-span-full text-center text-gray-500 mt-10">
                    <i class="fas fa-music text-4xl mb-4 block"></i>
                    検索して音楽を再生しましょう
                </div>
            </div>
        </section>
    </main>

    <footer id="player-bar" onclick="openFullPlayer()" class="fixed bottom-[64px] left-0 w-full bg-[#181818] border-t border-gray-800 p-2 flex items-center justify-between z-40 transition-transform translate-y-full cursor-pointer">
        <div class="flex items-center gap-3 w-2/3">
            <img id="currentThumb" src="" class="w-12 h-12 rounded shadow-md object-cover bg-gray-800">
            <div class="overflow-hidden text-left">
                <div id="currentTitle" class="text-sm font-bold truncate">曲名</div>
                <div id="currentArtist" class="text-xs text-gray-400 truncate">アーティスト</div>
            </div>
        </div>
        <div class="flex items-center gap-4 pr-2" onclick="event.stopPropagation()">
            <button id="favoriteBtn" class="text-xl text-gray-400 hover:text-white"><i class="far fa-heart"></i></button>
            <button id="playBtn" class="text-3xl text-white"><i id="playIcon" class="fas fa-play-circle"></i></button>
        </div>
        <div class="absolute top-0 left-0 w-full h-[2px] bg-gray-700">
            <div id="progressLine" class="h-full bg-green-500 w-0 transition-all duration-100"></div>
        </div>
    </footer>

    <div id="music-player-ui" class="fixed inset-0 bg-black z-[60] flex flex-col p-8 bg-gradient-to-b from-gray-900 to-black overflow-y-auto">
        <button onclick="closeFullPlayer()" class="text-2xl mb-8 self-start text-gray-400 hover:text-white"><i class="fas fa-chevron-down"></i></button>
        
        <div class="flex-1 flex flex-col items-center justify-center min-h-[300px]">
            <img id="fullThumb" src="" class="w-full aspect-square max-w-sm rounded-lg shadow-2xl mb-12 transition-transform duration-500 shadow-white/10 bg-gray-800">
            <div class="w-full text-left max-w-sm">
                <h1 id="fullTitle" class="text-2xl font-bold truncate">曲名</h1>
                <p id="fullArtist" class="text-lg text-gray-400 truncate">アーティスト</p>
            </div>
        </div>

        <div class="w-full max-w-sm mx-auto mb-12">
            <input type="range" id="fullSeekBar" value="0" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-white">
            <div class="flex justify-between text-xs text-gray-400 mt-2">
                <span id="currentTime">0:00</span>
                <span id="totalTime">0:00</span>
            </div>
            <div class="flex justify-around items-center mt-8">
                <button class="text-2xl text-gray-400 hover:text-white"><i class="fas fa-random"></i></button>
                <button class="text-3xl text-white hover:text-gray-300" onclick="skipTime(-10)"><i class="fas fa-backward"></i></button>
                <button id="fullPlayBtn" class="bg-white text-black w-16 h-16 rounded-full flex items-center justify-center text-2xl hover:scale-105 transition shadow-lg shadow-white/20">
                    <i id="fullPlayIcon" class="fas fa-play ml-1"></i>
                </button>
                <button class="text-3xl text-white hover:text-gray-300" onclick="skipTime(10)"><i class="fas fa-forward"></i></button>
                <button class="text-2xl text-gray-400 hover:text-white"><i class="fas fa-redo"></i></button>
            </div>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 w-full bg-black/95 border-t border-gray-900 flex justify-around items-center h-16 z-50 safe-area-bottom">
        <button onclick="showHome()" class="flex flex-col items-center gap-1 text-gray-400 nav-item active-tab" id="nav-home">
            <i class="fas fa-home text-xl"></i><span class="text-[10px]">ホーム</span>
        </button>
        <button onclick="document.getElementById('searchInput').focus()" class="flex flex-col items-center gap-1 text-gray-400 nav-item">
            <i class="fas fa-search text-xl"></i><span class="text-[10px]">検索</span>
        </button>
        <button onclick="showLibrary()" class="flex flex-col items-center gap-1 text-gray-400 nav-item" id="nav-lib">
            <i class="fas fa-book text-xl"></i><span class="text-[10px]">ライブラリ</span>
        </button>
    </nav>

    <audio id="audioPlayer" playsinline></audio>

    <script>
        const audio = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const playIcon = document.getElementById('playIcon');
        const fullPlayBtn = document.getElementById('fullPlayBtn');
        const fullPlayIcon = document.getElementById('fullPlayIcon');
        const searchInput = document.getElementById('searchInput');
        const resultsGrid = document.getElementById('resultsGrid');
        const playerBar = document.getElementById('player-bar');
        const progressLine = document.getElementById('progressLine');
        const fullSeekBar = document.getElementById('fullSeekBar');
        const loadingAlert = document.getElementById('loadingAlert');
        const fullPlayer = document.getElementById('music-player-ui');

        let currentTrack = null;
        let isLoading = false;
        let retryCount = 0;

        searchInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter') {
                const query = searchInput.value;
                if (!query) return;
                document.getElementById('viewTitle').innerText = `「${query}」の検索結果`;
                resultsGrid.innerHTML = '<div class="col-span-full text-center py-10"><i class="fas fa-spinner fa-spin text-3xl text-green-500"></i><p class="mt-2 text-gray-400">検索中...</p></div>';
                try {
                    const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                    const data = await res.json();
                    renderResults(data.results);
                } catch (err) { 
                    resultsGrid.innerHTML = '<div class="col-span-full text-center text-red-400 py-10">エラーが発生しました</div>';
                }
            }
        });

        function renderResults(songs) {
            resultsGrid.innerHTML = '';
            if(!songs || songs.length === 0){
                resultsGrid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-10">見つかりませんでした</div>';
                return;
            }
            songs.forEach(song => {
                const div = document.createElement('div');
                div.className = 'bg-[#181818] p-3 rounded-md active:scale-95 transition-transform cursor-pointer group hover:bg-[#282828]';
                div.innerHTML = `
                    <div class="relative w-full aspect-square mb-2">
                        <img src="${song.thumbnail}" class="w-full h-full object-cover rounded shadow-lg" loading="lazy">
                        <div class="absolute bottom-2 right-2 bg-green-500 text-black w-8 h-8 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition shadow-xl">
                            <i class="fas fa-play text-sm ml-1"></i>
                        </div>
                    </div>
                    <div class="text-sm font-bold truncate text-white">${song.title}</div>
                    <div class="text-xs text-gray-400 truncate">${song.author}</div>
                `;
                div.onclick = () => { retryCount = 0; playSong(song); };
                resultsGrid.appendChild(div);
            });
        }

        async function playSong(song) {
            currentTrack = song;
            isLoading = true;
            loadingAlert.classList.add('active');

            playerBar.classList.remove('translate-y-full');
            updateMeta(song);
            updateFavoriteIcon(song.videoId);

            audio.src = `/api/streamurl?video_id=${song.videoId}&retry=${retryCount}`;
            audio.load();
            
            try {
                await audio.play();
                isLoading = false;
                loadingAlert.classList.remove('active');
                updatePlayIcon(true);
            } catch (e) {
                console.error("Play error", e);
                // 最大3回まで自動リトライ
                if (retryCount < 3) {
                    retryCount++;
                    console.log(`再試行中... (${retryCount})`);
                    playSong(song);
                } else {
                    isLoading = false;
                    loadingAlert.classList.remove('active');
                    alert("この曲は現在再生できません。別の曲をお試しください。");
                }
            }

            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: song.title,
                    artist: song.author,
                    artwork: [{ src: song.thumbnail, sizes: '512x512', type: 'image/jpeg' }]
                });
                navigator.mediaSession.setActionHandler('play', () => { audio.play(); updatePlayIcon(true); });
                navigator.mediaSession.setActionHandler('pause', () => { audio.pause(); updatePlayIcon(false); });
                navigator.mediaSession.setActionHandler('previoustrack', () => skipTime(-10));
                navigator.mediaSession.setActionHandler('nexttrack', () => skipTime(10));
            }
        }

        function updateMeta(song) {
            document.getElementById('currentTitle').innerText = song.title;
            document.getElementById('currentArtist').innerText = song.author;
            document.getElementById('currentThumb').src = song.thumbnail;
            document.getElementById('fullTitle').innerText = song.title;
            document.getElementById('fullArtist').innerText = song.author;
            document.getElementById('fullThumb').src = song.thumbnail;
        }

        function updatePlayIcon(isPlaying) {
            const iconClass = isPlaying ? 'fas fa-pause-circle' : 'fas fa-play-circle';
            const fullIconClass = isPlaying ? 'fas fa-pause' : 'fas fa-play ml-1';
            playIcon.className = iconClass;
            fullPlayIcon.className = fullIconClass;
        }

        function togglePlay() {
            if (isLoading) return;
            if (audio.paused) { audio.play(); updatePlayIcon(true); }
            else { audio.pause(); updatePlayIcon(false); }
        }

        playBtn.onclick = (e) => { e.stopPropagation(); togglePlay(); };
        fullPlayBtn.onclick = togglePlay;

        audio.ontimeupdate = () => {
            if (!audio.duration) return;
            const pct = (audio.currentTime / audio.duration) * 100;
            progressLine.style.width = `${pct}%`;
            fullSeekBar.value = pct;
            document.getElementById('currentTime').innerText = formatTime(audio.currentTime);
            document.getElementById('totalTime').innerText = formatTime(audio.duration);
        };

        fullSeekBar.oninput = () => {
            if(audio.duration) audio.currentTime = (fullSeekBar.value / 100) * audio.duration;
        };

        function skipTime(sec) { audio.currentTime += sec; }

        function formatTime(sec) {
            if(isNaN(sec)) return "0:00";
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }

        function showHome() {
            document.getElementById('viewTitle').innerText = "注目の楽曲";
            setActiveTab('nav-home');
            document.getElementById('resultsGrid').innerHTML = '<div class="col-span-full text-center text-gray-500 mt-10"><i class="fas fa-music text-4xl mb-4 block"></i>検索して音楽を再生しましょう</div>';
        }

        function showLibrary() {
            document.getElementById('viewTitle').innerText = "ライブラリ";
            setActiveTab('nav-lib');
            const playlist = JSON.parse(localStorage.getItem('myPlaylist') || '[]');
            renderResults(playlist);
        }

        function setActiveTab(id) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active-tab'));
            document.getElementById(id).classList.add('active-tab');
        }

        function openFullPlayer() {
            fullPlayer.classList.add('active');
            document.getElementById('fullThumb').classList.add('scale-105');
        }
        function closeFullPlayer() {
            fullPlayer.classList.remove('active');
            document.getElementById('fullThumb').classList.remove('scale-105');
        }

        document.getElementById('favoriteBtn').onclick = (e) => {
            e.stopPropagation();
            if (!currentTrack) return;
            let playlist = JSON.parse(localStorage.getItem('myPlaylist') || '[]');
            const idx = playlist.findIndex(s => s.videoId === currentTrack.videoId);
            if (idx === -1) { playlist.push(currentTrack); } 
            else { playlist.splice(idx, 1); }
            localStorage.setItem('myPlaylist', JSON.stringify(playlist));
            updateFavoriteIcon(currentTrack.videoId);
            if(document.getElementById('nav-lib').classList.contains('active-tab')){ showLibrary(); }
        };

        function updateFavoriteIcon(videoId) {
            let playlist = JSON.parse(localStorage.getItem('myPlaylist') || '[]');
            const exists = playlist.some(s => s.videoId === videoId);
            document.getElementById('favoriteBtn').innerHTML = exists ? '<i class="fas fa-heart text-green-500"></i>' : '<i class="far fa-heart"></i>';
        }
    </script>
</body>
</html>
